---
title: "Seminar 3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R

Reading Dataset.
```{r, results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(haven) #чтение .dta файлов
library(kdensity) #ядерное сглаживание
library(scales) #отображение нескольких графиков на одном.
library(tsoutliers) #тест на нормальность

df <- read_dta(file = "housing.dta")
#attach(data)
```

## 2
Summary.
```{r}
summary(df)
```

## 3
```{r}
ggplot(data=df, aes(x=lotsize, y=price)) + geom_point() + geom_smooth(method='lm')
```

```{r}
ggplot(data=df, aes(x=bedrooms, y=price)) + geom_point() + geom_smooth(method='lm')
```

```{r}
ggplot(data=df, aes(x=bathrms, y=price)) + geom_point() + geom_smooth(method='lm')
```

```{r}
omit_4 <- filter(df, df$bathrms != 4)
ggplot(data=omit_4, aes(x=bathrms, y=price)) + geom_point() + geom_smooth(method='lm')
```

```{r}
ggplot(data=df, aes(x=bedrooms, y=price)) + geom_point() + geom_smooth(method='lm')
```

## 4
```{r}
m<-mean(df$price)
std<-sqrt(var(df$price))
ggplot(data=df, aes(x = price)) + geom_histogram(aes(y=..density..)) + stat_function(fun = dnorm, args = list(mean = m, sd = std))
```

### Не kdensity из стата, но похоже.
```{r}
ggplot(data=df, aes(x = price)) + geom_histogram(aes(y=..density..)) + geom_density()
```

## 5
```{r}
lin_m6 <- lm(df$price ~ df$lotsize + df$bedrooms + df$bathrms + df$airco)
df$resid <- resid(lin_m6)
ggplot(df, aes(x = price, y = resid)) + geom_point()
```

## 7
```{r}
df$price_hat <- predict(lin_m6)
ggplot(df, aes(x = price, y = price_hat)) + geom_point()  + geom_abline(slope = 1, color = "red")
```

```{r}
m<-mean(resid)
std<-sqrt(var(resid))
#hist(resid, density=40, breaks=40, prob=TRUE, 
#     xlab="Residuals",
#     main='')
#curve(dnorm(x, mean=m, sd=std), 
#      col="darkblue", lwd=2, add=TRUE, yaxt="n")
#
ggplot(data=df, aes(x = resid)) + geom_histogram(aes(y=..density..)) + stat_function(fun = dnorm, args = list(mean = m, sd = std))
```

## 8
### Отличается от sktest в stata
```{r}

tseries::jarque.bera.test(resid)
```

```{r}
shapiro.test(resid)
```

## Stata
```{r}
library(devtools)
devtools::install_github("Hemken/Statamarkdown")
```

Setting up Stata.
```{r, echo=FALSE, message=FALSE}
library(Statamarkdown)
stataexe <- find_stata()
knitr::opts_chunk$set(engine.path=stataexe)
```

```{stata}

/*1 use data housing.dta*/

/*2*/
sum

/*3*/
twoway dot price lotsize || lfit price lotsize
twoway dot price bedrooms || lfit price bedrooms
twoway scatter price bathrms || lfit  price bathrms
twoway dot price bathrms if bathrms!=4 || lfit  price bathrms if bathrms!=4
twoway dot price bedrooms || dot  price bathrms 

/*4*/
hist price, norm
twoway hist price ||kdensity  price

/*5*/
reg price lotsize bedrooms bathrms airco

/*7*/

predict resid_a, resid
predict price_hat, xb

gen n=_n
twoway scatter resid_a n
twoway scatter resid_a price
twoway dot price_hat price || line price price

/*8*/

hist resid_a, norm
sktest resid_a
swilk resid_a
```